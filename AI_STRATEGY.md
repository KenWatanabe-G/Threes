# Threes! AI 戦略ドキュメント

## デッキシステムの仕様

### 12枚のデッキシステム（実装済み✅）

Threes!は完全ランダムではなく、**12枚のカードデッキ**システムを使用しています。

#### デッキの内容（1セット）
- **1（青）**: 4枚
- **2（赤）**: 4枚
- **3（白）**: 4枚

#### 動作
1. ゲーム開始時に12枚をシャッフル
2. 1枚ずつデッキから引く
3. 12枚すべて使い切ると、新しい12枚セットを補充してシャッフル

#### 戦略的意味
- 「1」が4枚連続で出た場合、次のデッキまで「1」は出ない
- 出現確率は均等：1, 2, 3それぞれ1/3
- 予測可能性が高まる（完全ランダムより戦略的）

### ボーナスカードシステム（実装済み✅）

#### 出現条件
- **盤面に48以上のタイルが存在する**場合のみ
- デッキから「3」が引かれた時、約**1/21の確率**でボーナスカードに変換

#### ボーナスカードの値
- **最大タイル値 ÷ 8** 以下の値がランダムに出現
- 例：
  - 最大タイルが48の場合: **6**が出る可能性
  - 最大タイルが96の場合: **6または12**が出る可能性
  - 最大タイルが192の場合: **6、12、または24**が出る可能性

#### 表示
- 通常の「3」: そのまま表示
- ボーナスカード: **数字の後ろに「+」を表示**（例：6+、12+）

## 現状の実装状況

### ✅ 実装済み
1. 12枚デッキシステム（Fisher-Yatesシャッフル）
2. デッキ自動補充機能
3. ボーナスカード生成ロジック
4. 次のタイルプレビュー（ボーナス表示含む）
5. 角固定戦略（最優先評価）
6. モノトニシティ評価
7. 次のタイルを考慮した評価関数

## 基本戦略

### コアコンセプト：角固定戦略（右下基準）✅実装済み

**最も重要な原則：最大タイルを右下の角に固定し、絶対に動かさない**

```
推奨配置例（右下角を基準とする場合）：

  3   6  12  24
  6  12  24  48
 12  24  48  96
 24  48  96 192 ← 右下に最大値
```

### 戦略の優先順位

#### 1. 角固定の維持（最優先）✅実装済み
- **目標**: 最大タイルを右下の角に配置し、絶対に動かさない
- **実装**:
  - 右下の角に最大タイル: +10,000点
  - 右端または下辺に最大タイル: +5,000点
  - 中央に最大タイル: -3,000点（大ペナルティ）

#### 2. 単調性（モノトニシティ）の維持 ✅実装済み
- **目標**: タイルの値が一方向に単調増加/減少する配置
- **実装**:
  ```
  理想的な並び（右下角基準）:
  - 各行: 右から左に減少 (192 > 96 > 48 > 24)
  - 各列: 下から上に減少 (192 > 96 > 48 > 24)
  ```
- **評価**: モノトニシティスコア ×1,000

#### 3. マージの機会を最大化 ✅実装済み
- **目標**: 次の手でマージ可能なタイルのペアを作る
- **考慮点**:
  - 1と2は隣接させる
  - 同じ値のタイル（3以上）は隣接させる
  - **次のタイルプレビューを見て、マージ可能な配置にする**
- **評価**: マージ可能ペア ×400

#### 4. 空きスペースの確保 ✅実装済み
- **目標**: 移動の自由度を保つ
- **実装**: 空きセルが多いほど高評価
- **評価**: 空きマス数 ×500

#### 5. 特定方向への偏り（推奨操作）
- **目標**: 主に2方向のみで操作する（**右と下のみ**を推奨）
- **理由**: タイルの配置が予測しやすくなり、右下への集約が容易

## 改善すべき評価関数

### 現在の評価基準と重み

```javascript
1. 空きマスの数: ×100
2. タイルの合計値: ×10
3. 最大タイル: ×50
4. 位置ボーナス: タイル値 × 位置係数
5. マージ可能ペア: ×200
6. モノトニシティ: ×30
```

### 推奨する新しい評価基準

```javascript
1. 角固定ペナルティ: ×10000 (最優先)
   - 最大タイルが角から動く場合: -10000

2. モノトニシティ: ×1000 (重要度UP)
   - 単調性が高いほど高評価

3. 最大タイル位置: ×5000 (重要度UP)
   - 角に最大タイル: +5000
   - 辺に最大タイル: +2500
   - 中央に最大タイル: -2500

4. 空きマスの数: ×500 (重要度UP)

5. マージ可能ペア: ×300 (維持)
   - 次のタイルも考慮する

6. スムーズネス（隣接差分）: ×100 (新規)
   - 隣接タイルの値の差が小さいほど良い

7. タイルの合計値: ×10 (維持)
```

## 次のタイルプレビューの活用

### 実装すべき機能

1. **次タイルを考慮したシミュレーション**
   ```javascript
   // 各移動後に次のタイルが追加される位置を予測
   // その結果も含めて評価する
   evaluateWithNextTile(direction, nextTileValue) {
       // 1. 移動をシミュレート
       // 2. 次のタイルが追加される可能性のある位置を全て試す
       // 3. 最悪ケースと最良ケースの平均を取る
   }
   ```

2. **次タイルに基づく戦術**
   - 次が1か2の場合: 1と2が隣接する配置を優先
   - 次が3の場合: 既存の3と隣接できる配置を優先
   - 次が大きい数字: 空きスペースを確保

## 具体的な移動判断フロー

```
1. 角の最大タイルチェック
   └─ 最大タイルが動く？
      ├─ YES → その方向を除外（大ペナルティ）
      └─ NO  → 次へ

2. 各方向をシミュレート
   └─ 移動後の盤面を評価
      ├─ モノトニシティスコア
      ├─ 空きスペーススコア
      ├─ マージ機会スコア（次タイル考慮）
      └─ 位置スコア

3. 次のタイルを考慮
   └─ 各方向で次タイル追加後を評価
      └─ 期待値を計算

4. 最高評価の方向を選択
```

## 特殊ケースの処理

### 詰み回避
- 移動可能な方向が1つしかない場合でも、次の手を考慮
- 角の最大タイルを守るために一時的に不利な手を打つことも許容

### 緊急時の戦略変更
- 空きマスが2以下: 空きスペース最優先
- マージ不可能な状態が多い: モノトニシティ最優先

## 実装の優先順位

1. ✅ **最優先**: 角固定戦略の実装
2. ✅ **高**: モノトニシティの重み調整
3. ✅ **高**: 次のタイルを考慮した評価
4. ⬜ **中**: スムーズネス評価の追加
5. ⬜ **低**: 複数手先読み（計算コストが高い）

## 期待される改善

### 現在の推定性能
- 平均最大タイル: 192-384
- 平均スコア: 2000-4000

### 改善後の目標性能
- 平均最大タイル: 768-1536
- 平均スコア: 8000-15000
- 1536タイル到達率: 50%以上

## 参考資料

- 2048 AIアルゴリズム研究（Threes!と類似）
- Expectimax アルゴリズム
- Monte Carlo Tree Search (MCTS)
